// File: prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  password       String
  role           Role     @default(USER)
  fingerprintId  String?  @unique
  cardUid        String?  @unique
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

enum Role {
  ADMIN
  USER
}

model DeviceExternal {
  id                         String                  @id @default(cuid())
  uniqId                     String                  @unique @default(cuid())
  name                       String
  topic                      String                  @unique
  address                    String?
  createdAt                  DateTime                @default(now())
  updatedAt                  DateTime                @updatedAt
  loggingConfigs             LoggingConfiguration[]

  sourceForBillConfigs       BillConfiguration[]     @relation("SourceDeviceForBill")
  // Untuk relasi publishTargetForBill, ini adalah sisi "satu" dari one-to-one
  publishTargetForBillConfig BillConfiguration?      @relation("PublishTargetForBill") // Ini adalah sisi "pemilik" relasi one-to-one

  // Untuk relasi PueApiTopic, ini adalah sisi "satu" dari one-to-one
  pueApiTopicConfig          PueConfiguration?       @relation("PueApiTopic") // Ini adalah sisi "pemilik" relasi one-to-one
}

model LoggingConfiguration {
  id           String         @id @default(cuid())
  customName   String
  key          String
  units        String?
  multiply     Float?         @default(1)
  deviceUniqId String
  device       DeviceExternal @relation(fields: [deviceUniqId], references: [uniqId])
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  @@unique([deviceUniqId, key])
}

model LoggedData {
  id        String   @id @default(cuid())
  configId  String
  value     Float
  timestamp DateTime @default(now())
}

model BillConfiguration {
  id                        String         @id @default(cuid())
  customName                String         @unique

  sourceDeviceUniqId        String
  sourceDevice              DeviceExternal @relation("SourceDeviceForBill", fields: [sourceDeviceUniqId], references: [uniqId])
  sourceDeviceKey           String

  // PERBAIKAN 1: Tambahkan @unique ke publishTargetDeviceUniqId untuk one-to-one
  publishTargetDeviceUniqId String @unique // <-- Tambahkan @unique di sini
  publishTargetDevice       DeviceExternal @relation("PublishTargetForBill", fields: [publishTargetDeviceUniqId], references: [uniqId])

  rupiahRatePerKwh          Float          @default(1467)
  dollarRatePerKwh          Float          @default(0.1)

  createdAt                 DateTime       @default(now())
  updatedAt                 DateTime       @updatedAt

  logs                      BillLog[]
}

model BillLog {
  id             String            @id @default(cuid())
  configId       String
  config         BillConfiguration @relation(fields: [configId], references: [id], onDelete: Cascade)

  rawValue       Float
  rupiahCost     Float
  dollarCost     Float

  timestamp      DateTime          @default(now())
}

model PueConfiguration {
  id                   String   @id @default(cuid())
  customName           String   @unique
  type                 String   @default("pue")

  apiTopicUniqId       String?  @unique // Ini adalah foreign key di PueConfiguration
  // PERBAIKAN 2 & 3: Pastikan relasi balik didefinisikan dengan benar
  apiTopic             DeviceExternal? @relation("PueApiTopic", fields: [apiTopicUniqId], references: [uniqId])
                                  // Tidak perlu field tambahan di DeviceExternal untuk relasi ini,
                                  // karena `pueApiTopicConfig` sudah ada dan Prisma akan menghubungkannya.
                                  // Hanya perlu memastikan nama relasi ("PueApiTopic") cocok di kedua sisi.

  pduList              Json? @db.JsonB
  mainPower            Json? @db.JsonB

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}